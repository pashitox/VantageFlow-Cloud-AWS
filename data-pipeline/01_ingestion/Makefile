.PHONY: help clean ingest monitor test verify install-deps run-all

help:
	@echo "================================================================="
	@echo "üöÄ COMANDOS DISPONIBLES PARA INGESTA DE DATOS IoT"
	@echo "================================================================="
	@echo ""
	@echo "  make help         - Muestra este mensaje de ayuda"
	@echo "  make install-deps - Instala dependencias Python (boto3, pandas, numpy)"
	@echo "  make clean        - Limpia todo para empezar fresco"
	@echo "  make test         - Prueba con un lote peque√±o (50 registros)"
	@echo "  make ingest       - Ejecuta ingesta completa (3 lotes x 200 registros)"
	@echo "  make monitor      - Monitorea logs en tiempo real (30 segundos)"
	@echo "  make verify       - Verifica estado del pipeline"
	@echo "  make run-all      - Ejecuta TODO: clean ‚Üí ingest ‚Üí verify"
	@echo ""
	@echo "üí° Ejemplo r√°pido: make run-all"
	@echo "================================================================="

install-deps:
	@echo "üì¶ INSTALANDO DEPENDENCIAS PYTHON..."
	@echo "   Este paso ya lo hiciste en el entorno virtual"
	@echo "   ‚úÖ Dependencias ya instaladas:"
	@echo "   ‚Ä¢ boto3  - AWS SDK para Python"
	@echo "   ‚Ä¢ pandas - Manipulaci√≥n de datos"
	@echo "   ‚Ä¢ numpy  - C√°lculos num√©ricos"
	@python3 -c "import boto3, pandas, numpy; print('   ‚úÖ Todas las dependencias funcionan correctamente')"

clean:
	@echo "üßπ EJECUTANDO LIMPIEZA INICIAL..."
	@chmod +x clean_start.sh 2>/dev/null || true
	@./clean_start.sh
	@echo "‚úÖ Limpieza completada - Listo para nueva ingesta"

ingest:
	@echo "================================================================="
	@echo "üöÄ INICIANDO INGESTA PROFESIONAL"
	@echo "================================================================="
	@echo "Configuraci√≥n:"
	@echo "   ‚Ä¢ Lotes: 3"
	@echo "   ‚Ä¢ Registros por lote: 200"
	@echo "   ‚Ä¢ Total estimado: 600 registros"
	@echo "================================================================="
	@python3 s3_data_ingestor.py --batches 3 --records 200

test:
	@echo "üß™ EJECUTANDO PRUEBA R√ÅPIDA"
	@echo "   ‚Ä¢ Lotes: 1"
	@echo "   ‚Ä¢ Registros por lote: 50"
	@echo "   ‚Ä¢ Total: 50 registros"
	@python3 s3_data_ingestor.py --batches 1 --records 50

monitor:
	@echo "üîç MONITOREANDO PIPELINE EN TIEMPO REAL"
	@echo "Presiona Ctrl+C para detener en cualquier momento"
	@echo ""
	@echo "=== √öLTIMOS LOGS (30 segundos) ==="
	@echo ""
	@echo "üìä LAMBDA BRONZE ‚Üí SILVER:"
	@timeout 30 aws logs tail /aws/lambda/vantageflow-process-iot --follow 2>/dev/null || echo "   No hay logs recientes o timeout"
	@echo ""
	@echo "üìä LAMBDA SILVER ‚Üí GOLD:"
	@timeout 30 aws logs tail /aws/lambda/vantageflow-silver-to-gold --follow 2>/dev/null || echo "   No hay logs recientes o timeout"

verify:
	@echo "üìä VERIFICANDO ESTADO COMPLETO DEL PIPELINE"
	@echo "============================================"
	@echo ""
	@echo "1. üìÅ ARCHIVOS EN S3:"
	@echo "---------------------"
	@aws s3 ls s3://vantageflow-dev-data-lake-21bcb50a/ --recursive --human-readable 2>/dev/null | grep -v ".keep" | head -20 || echo "   No hay archivos o error"
	@echo ""
	@echo "2. ‚ö° ESTADO DE LAMBDAS:"
	@echo "-----------------------"
	@echo -n "   ‚Ä¢ vantageflow-process-iot: "
	@aws lambda get-function --function-name vantageflow-process-iot --query "Configuration.State" --output text 2>/dev/null || echo "Error"
	@echo -n "   ‚Ä¢ vantageflow-silver-to-gold: "
	@aws lambda get-function --function-name vantageflow-silver-to-gold --query "Configuration.State" --output text 2>/dev/null || echo "Error"
	@echo ""
	@echo "3. üîó TRIGGERS ACTIVOS:"
	@echo "----------------------"
	@aws s3api get-bucket-notification-configuration --bucket vantageflow-dev-data-lake-21bcb50a --query "LambdaFunctionConfigurations[*].Id" --output text 2>/dev/null | tr '\t' '\n' | while read trigger; do echo "   ‚Ä¢ $trigger"; done || echo "   No se pudieron leer los triggers"
	@echo ""
	@echo "4. üìà RESUMEN POR CAPA:"
	@echo "----------------------"
	@for layer in bronze silver gold anomalies; do \
		count=$$(aws s3 ls s3://vantageflow-dev-data-lake-21bcb50a/$$layer/ --recursive 2>/dev/null | grep -v ".keep" | wc -l); \
		echo "   ‚Ä¢ $${layer^^}: $$count archivos"; \
	done
	@echo "============================================"

run-all:
	@echo "üéØ EJECUTANDO PIPELINE COMPLETO AUTOM√ÅTICO"
	@echo "=========================================="
	@$(MAKE) clean
	@echo ""
	@$(MAKE) ingest
	@echo ""
	@$(MAKE) verify
	@echo ""
	@echo "‚úÖ PIPELINE COMPLETO EJECUTADO EXITOSAMENTE"
	@echo "=========================================="
